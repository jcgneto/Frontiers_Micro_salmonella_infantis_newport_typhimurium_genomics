---
title: "phylogenetic independent analysis"
author: "Joao Carlos Gomes-Neto"
date: "1/6/2021"
output: html_document
---

Load packages

```{r, include = FALSE}
# Load packages

library(tidyverse)
library(skimr)
library(RColorBrewer)
library(gridExtra)
library(lattice)
library(ggpubr)
library(vegan)
library(reshape2)
library(ggrepel)
library(ggnewscale)
library(forcats)
library(naniar)
library(data.table)
library(rARPACK)
library(logisticPCA)
library(cluster)
library(factoextra)
library(NbClust)
```

Plots kmer and snp_distance-based distance tSNE analysis Infantis

```{r, include = FALSE}

# Enter kmer-matrix

data1 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/kmer_matrix/kmer_infantis.csv")

mlst <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/input_data/salmonellast_output.csv')

# QC the data

skim(mlst)

# Generate the id column 

mlst$id2 <- sapply(strsplit(as.character(mlst$FILE),'_'), "[", 1)

# Select columns of interest

s1 <- mlst %>%
          select(id2, ST) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") %>%
                  rename(id = id2)

# st

s1$st <- ifelse(s1$ST == 32, "ST32", "Other STs")

data2 <- s1

####################################################################

# Enter SISTR results

sistr <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/input_data/sistr_all.csv')

# QC the data 

skim(sistr)

# Generate the id column 

sistr$id <- sapply(strsplit(as.character(sistr$genome),'_'), "[", 1)

# Select columns 

sis1 <- sistr %>%
            select(id, cgmlst_ST, serovar_cgmlst) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") 

sis1$serovar <- ifelse(sis1$serovar_cgmlst == "Infantis", "Infantis",
                            "Other serovars")

sis1 <- mutate(sis1, cgmlst = ifelse(cgmlst_ST %in% 2242423463, "cgMLST 2242423463",
                                            "Other cgMLSTs"))

data3 <- sis1

############################################################

# Enter Baps 1-6 

baps <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/input_data/fastbaps_partition_baps_prior_l6.csv')

# Changing column names 

colnames(baps)[1:2] <- c("id", "baps_1") 

# Select colunms id and baps_1
b1 <- baps %>% 
              select(id, baps_1)


data4 <- b1

# Merge 

data5 <- left_join(data1, data2, on = "id")

# Merge

data6 <- left_join(data3, data4, on = "id")

# Merge

data7 <- left_join(data5, data6, on = "id")

####################################################

# Make the plots 

# Plot serovar

serovar_data <- data7 %>%
              drop_na(serovar) %>%
              select(tSNE1, tSNE2, serovar) 

serovar_plot <- ggplot(serovar_data, aes(x = tSNE1, y = tSNE2, color = serovar)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "gray")) +
   ggtitle("Serovar (kmer-distance)") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='Serovar') + 
  geom_jitter(pch = 21, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))
serovar_plot


# Plot baps_1

baps_data <- data7 %>%
              drop_na(baps_1) %>%
              select(tSNE1, tSNE2, baps_1) 
baps_data$baps_1 <- factor(baps_data$baps_1, levels=c("1", "2", "3"))


baps_plot <- ggplot(baps_data, aes(x = tSNE1, y = tSNE2, color = baps_1)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkred", "purple", "darkgreen")) +
   ggtitle("A.") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='BAPS1') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
baps_plot

# Plot ST

st_data <- data7 %>%
              #drop_na(st) %>%
  mutate(st = replace_na(st, "Other STs")) %>%
              select(tSNE1, tSNE2, st) 
st_data$st <- factor(st_data$st, levels=c("ST32","Other STs"))


st_plot <- ggplot(st_data, aes(x = tSNE1, y = tSNE2, color = st)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkred", "gray")) +
   ggtitle("B.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='ST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
st_plot


# Plot cgmlst 

cgmlst_data <- data7 %>%
              drop_na(cgmlst) %>%
              select(tSNE1, tSNE2, cgmlst) 
cgmlst_data$cgmlst <- factor(cgmlst_data$cgmlst, levels=c("cgMLST 2242423463",
                                            "Other cgMLSTs"))


cgmlst_plot <- ggplot(cgmlst_data, aes(x = tSNE1, y = tSNE2, color = cgmlst)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("black", "orange")) +
   ggtitle("C.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='cgMLST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
cgmlst_plot

##################################################################

#######################################################################

# Enter snp-matrix

data1 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/snp_matrix/snp_infantis.csv")

mlst <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/input_data/salmonellast_output.csv')

# QC the data

skim(mlst)

# Generate the id column 

mlst$id2 <- sapply(strsplit(as.character(mlst$FILE),'_'), "[", 1)

# Select columns of interest

s1 <- mlst %>%
          select(id2, ST) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") %>%
                  rename(id = id2)

# st

s1$st <- ifelse(s1$ST == 32, "ST32", "Other STs")

data2 <- s1

####################################################################

# Enter SISTR results

sistr <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/input_data/sistr_all.csv')

# QC the data 

skim(sistr)

# Generate the id column 

sistr$id <- sapply(strsplit(as.character(sistr$genome),'_'), "[", 1)

# Select columns 

sis1 <- sistr %>%
            select(id, cgmlst_ST, serovar_cgmlst) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") 

sis1$serovar <- ifelse(sis1$serovar_cgmlst == "Infantis", "Infantis",
                            "Other serovars")

sis1 <- mutate(sis1, cgmlst = ifelse(cgmlst_ST %in% 2242423463, "cgMLST 2242423463",
                                            "Other cgMLSTs"))

data3 <- sis1

############################################################

# Enter Baps 1-6 

baps <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/input_data/fastbaps_partition_baps_prior_l6.csv')

# Changing column names 

colnames(baps)[1:2] <- c("id", "baps_1") 

# Select colunms id and baps_1
b1 <- baps %>% 
              select(id, baps_1)


data4 <- b1

# Merge 

data5 <- left_join(data1, data2, on = "id")

# Merge

data6 <- left_join(data3, data4, on = "id")

# Merge

data7 <- left_join(data5, data6, on = "id")


####################################################

# Make the plots 

# Plot serovar

serovar_data2 <- data7 %>%
              drop_na(serovar) %>%
              select(tSNE1, tSNE2, serovar) 

serovar_plot2 <- ggplot(serovar_data2, aes(x = tSNE1, y = tSNE2, color = serovar)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "gray")) +
   ggtitle("Serovar (SNP-distance)") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='Serovar') + 
  geom_jitter(pch = 21, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))
serovar_plot2

# Plot baps_1

baps_data2 <- data7 %>%
              drop_na(baps_1) %>%
              select(tSNE1, tSNE2, baps_1) 
baps_data2$baps_1 <- factor(baps_data2$baps_1, levels=c("1", "2", "3"))



baps_plot2 <- ggplot(baps_data2, aes(x = tSNE1, y = tSNE2, color = baps_1)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkred", "purple", "darkgreen")) +
   ggtitle("E.") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='BAPS1') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
baps_plot2


# Plot ST

st_data2 <- data7 %>%
              #drop_na(st) %>%
    mutate(st = replace_na(st, "Other STs")) %>%
              select(tSNE1, tSNE2, st) 
st_data2$st <- factor(st_data2$st, levels=c("ST32", "Other STs"))


st_plot2 <- ggplot(st_data2, aes(x = tSNE1, y = tSNE2, color = st)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkred", "gray")) +
   ggtitle("F.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='ST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
st_plot2


# Plot cgmlst 

cgmlst_data2 <- data7 %>%
              drop_na(cgmlst) %>%
              select(tSNE1, tSNE2, cgmlst) 
cgmlst_data2$cgmlst <- factor(cgmlst_data2$cgmlst, levels=c("cgMLST 2242423463",
                                            "Other cgMLSTs"))


cgmlst_plot2 <- ggplot(cgmlst_data2, aes(x = tSNE1, y = tSNE2, color = cgmlst)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("black", "orange")) +
   ggtitle("G.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='cgMLST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
cgmlst_plot2
```

Cluster analysis using core genome information Infantis

```{r, include = FALSE}

# kmer data (2d)
# enter the data

data1 <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/kmer_matrix/kmer_infantis.csv')

#  Non-supervised kmeans clustering analysis

cluster_data <- data1 %>% select(tSNE1, tSNE2)

# determine the number of clusters with the elbow method

set.seed(123)

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(cluster_data, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

# or can use this function
set.seed(123)

p1 <- fviz_nbclust(cluster_data, kmeans, method = "wss")
p1 

# silhouette method
set.seed(123)
a1 <- fviz_nbclust(cluster_data, kmeans, method = "silhouette")
a1

# combining both approaches we determine that 2 clusters are enough 
set.seed(123)
km.final <- kmeans(cluster_data, 2)
data1$cluster <- km.final$cluster
data1$cluster <- as.factor(data1$cluster)

# plot the kmer 2d cluster data

kmercluster <- ggplot(data1, aes(x = tSNE1, y = tSNE2, color = cluster)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("gray", "darkred")) +
   ggtitle("D.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Kmeans clusters') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
kmercluster

######################################################################################

# snp data (2d)
# enter the data

data1 <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/infantis/snp_matrix/snp_infantis.csv')

#  Non-supervised kmeans clustering analysis

cluster_data <- data1 %>% select(tSNE1, tSNE2)

# determine the number of clusters with the elbow method

set.seed(123)

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(cluster_data, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

# or can use this function
set.seed(123)

p2 <- fviz_nbclust(cluster_data, kmeans, method = "wss")
p2 

# silhouette method
set.seed(123)
a2 <- fviz_nbclust(cluster_data, kmeans, method = "silhouette")
a2

# combining both approaches we determine that 2 clusters are enough 
set.seed(123)
km.final <- kmeans(cluster_data, 3)
data1$cluster <- km.final$cluster
data1$cluster <- as.factor(data1$cluster)

# plot the kmer 2d cluster data

snpcluster <- ggplot(data1, aes(x = tSNE1, y = tSNE2, color = cluster)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("gray", "darkred", "darkblue")) +
   ggtitle("H.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Kmeans clusters') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
snpcluster
```

Plots kmer and snp_distance-based distance tSNE analysis Newport

```{r, include = FALSE}

# Enter kmer-matrix

data1 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/kmer_matrix/kmer_newport.csv")

mlst <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/input_data/salmonellast_output.csv')

# QC the data

skim(mlst)

# Generate the id column 

mlst$id2 <- sapply(strsplit(as.character(mlst$FILE),'_'), "[", 1)

# Select columns of interest

s1 <- mlst %>%
          select(id2, ST) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") %>%
                  rename(id = id2)

# st

s1$st <- ifelse(s1$ST == 5, "ST5", 
                   ifelse(s1$ST == 45, "ST45", 
                          ifelse(s1$ST == 118, "ST118", "Other STs")))

data2 <- s1

####################################################################

# Enter SISTR results

sistr <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/input_data/sistr_output.csv')

# QC the data 

skim(sistr)

# Generate the id column 

sistr$id <- sapply(strsplit(as.character(sistr$genome),'_'), "[", 1)

# Select columns 

sis1 <- sistr %>%
            select(id, cgmlst_ST, serovar_cgmlst) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") 

sis1$serovar <- ifelse(sis1$serovar_cgmlst == "Newport", "Newport",
                            "Other serovars")

sis1 <- mutate(sis1, cgmlst = ifelse(cgmlst_ST %in% 1468400426, "cgMLST 1468400426",
                                     ifelse(cgmlst_ST %in% 88443731, "cgMLST 88443731", 
                                            ifelse(cgmlst_ST %in% 1271156802, "cgMLST 1271156802",
                                            "Other cgMLSTs"))))
data3 <- sis1

############################################################

# Enter Baps 1-6 

baps <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/input_data/fastbaps_partition_baps_prior_l6.csv')

# Changing column names 

colnames(baps)[1:2] <- c("id", "baps_1") 

# Select colunms id and baps_1
b1 <- baps %>% 
              select(id, baps_1)


data4 <- b1

# Merge 

data5 <- left_join(data1, data2, on = "id")

# Merge

data6 <- left_join(data3, data4, on = "id")

# Merge

data7 <- left_join(data5, data6, on = "id")

####################################################

# Make the plots 

# Plot serovar

serovar_data <- data7 %>%
              drop_na(serovar) %>%
              select(tSNE1, tSNE2, serovar) 

serovar_plot <- ggplot(serovar_data, aes(x = tSNE1, y = tSNE2, color = serovar)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "gray")) +
   ggtitle("Serovar (kmer-distance)") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='Serovar') + 
  geom_jitter(pch = 21, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))
serovar_plot


# Plot baps_1

baps_data <- data7 %>%
              drop_na(baps_1) %>%
              select(tSNE1, tSNE2, baps_1) 
baps_data$baps_1 <- factor(baps_data$baps_1, levels=c("1", "2", "3", "4", "5", "6", "7", "8", "9"))


baps_plot <- ggplot(baps_data, aes(x = tSNE1, y = tSNE2, color = baps_1)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("cornflowerblue", "darkgreen", "gray", "darkred", "darkblue", "darkcyan",
                              "black", "orange", "brown")) +
   ggtitle("I.") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='BAPS1') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))

baps_plot


# Plot ST

st_data <- data7 %>%
              #drop_na(st) %>%
            mutate(st = replace_na(st, "Other STs")) %>%
              select(tSNE1, tSNE2, st) 
st_data$st <- factor(st_data$st, levels=c("ST5", "ST45", "ST118", "Other STs"))


st_plot <- ggplot(st_data, aes(x = tSNE1, y = tSNE2, color = st)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("orange", "darkblue", "purple", "darkgreen")) +
   ggtitle("J.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='ST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
st_plot


# Plot cgmlst 

cgmlst_data <- data7 %>%
              drop_na(cgmlst) %>%
              select(tSNE1, tSNE2, cgmlst) 
cgmlst_data$cgmlst <- factor(cgmlst_data$cgmlst, levels=c("cgMLST 1468400426", "cgMLST 88443731", "cgMLST 1271156802", "Other cgMLSTs"))


cgmlst_plot <- ggplot(cgmlst_data, aes(x = tSNE1, y = tSNE2, color = cgmlst)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkred", "darkblue", "darkgreen", "gray",
                          "orange", "black")) +
   ggtitle("K.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='cgMLST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
cgmlst_plot

#######################################################################

# Enter snp-matrix

data1 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/snp_matrix/snp_newport.csv")

mlst <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/input_data/salmonellast_output.csv')

# QC the data

skim(mlst)

# Generate the id column 

mlst$id2 <- sapply(strsplit(as.character(mlst$FILE),'_'), "[", 1)

# Select columns of interest

s1 <- mlst %>%
          select(id2, ST) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") %>%
                  rename(id = id2)

# st

s1$st <- ifelse(s1$ST == 5, "ST5", 
                   ifelse(s1$ST == 45, "ST45", 
                          ifelse(s1$ST == 118, "ST118", "Other STs")))

data2 <- s1

####################################################################

# Enter SISTR results

sistr <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/input_data/sistr_output.csv')

# QC the data 

skim(sistr)

# Generate the id column 

sistr$id <- sapply(strsplit(as.character(sistr$genome),'_'), "[", 1)

# Select columns 

sis1 <- sistr %>%
            select(id, cgmlst_ST, serovar_cgmlst) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") 

sis1$serovar <- ifelse(sis1$serovar_cgmlst == "Newport", "Newport",
                            "Other serovars")

sis1 <- mutate(sis1, cgmlst = ifelse(cgmlst_ST %in% 1468400426, "cgMLST 1468400426",
                                     ifelse(cgmlst_ST %in% 88443731, "cgMLST 88443731", 
                                            ifelse(cgmlst_ST %in% 1271156802, "cgMLST 1271156802",
                                            "Other cgMLSTs"))))
data3 <- sis1

############################################################

# Enter Baps 1-6 

baps <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/input_data/fastbaps_partition_baps_prior_l6.csv')

# Changing column names 

colnames(baps)[1:2] <- c("id", "baps_1") 

# Select colunms id and baps_1
b1 <- baps %>% 
              select(id, baps_1)


data4 <- b1

# Merge 

data5 <- left_join(data1, data2, on = "id")

# Merge

data6 <- left_join(data3, data4, on = "id")

# Merge

data7 <- left_join(data5, data6, on = "id")

####################################################

# Make the plots 

# Plot serovar

serovar_data2 <- data7 %>%
              drop_na(serovar) %>%
              select(tSNE1, tSNE2, serovar) 

serovar_plot2 <- ggplot(serovar_data2, aes(x = tSNE1, y = tSNE2, color = serovar)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "gray")) +
   ggtitle("M. Serovar (SNP-distance)") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='Serovar') + 
  geom_jitter(pch = 21, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))
serovar_plot2

# Plot baps_1

baps_data2 <- data7 %>%
              drop_na(baps_1) %>%
              select(tSNE1, tSNE2, baps_1) 
baps_data2$baps_1 <- factor(baps_data2$baps_1, levels=c("1", "2", "3", "4", "5", "6", "7", "8", "9"))


baps_plot2 <- ggplot(baps_data2, aes(x = tSNE1, y = tSNE2, color = baps_1)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("cornflowerblue", "darkgreen", "gray", "darkred", "darkblue", "darkcyan",
                              "black", "orange", "brown")) +
   ggtitle("M.") +
  theme(plot.title = element_text(size = 50, face = "bold")) +
  labs(color='BAPS1') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))+
    guides(color = guide_legend(override.aes = list(size=20)))
baps_plot2


# Plot ST

st_data2 <- data7 %>%
              #drop_na(st) %>%
  mutate(st = replace_na(st, "Other STs")) %>%
              select(tSNE1, tSNE2, st) 
st_data2$st <- factor(st_data2$st, levels=c("ST5", "ST45", "ST118", "Other STs"))


st_plot2 <- ggplot(st_data2, aes(x = tSNE1, y = tSNE2, color = st)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("orange", "darkblue", "purple", "darkgreen")) +
   ggtitle("N.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='ST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
st_plot2


# Plot cgmlst 

cgmlst_data2 <- data7 %>%
              drop_na(cgmlst) %>%
              select(tSNE1, tSNE2, cgmlst) 
cgmlst_data2$cgmlst <- factor(cgmlst_data2$cgmlst, levels=c("cgMLST 1468400426", "cgMLST 88443731", "cgMLST 1271156802", "Other cgMLSTs"))


cgmlst_plot2 <- ggplot(cgmlst_data2, aes(x = tSNE1, y = tSNE2, color = cgmlst)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkred", "darkblue", "darkgreen", "gray",
                          "orange", "black")) +
   ggtitle("O.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='cgMLST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
    guides(color = guide_legend(override.aes = list(size=20)))
cgmlst_plot2
```

Cluster analysis using core genome information Newport

```{r, include = FALSE}

# kmer data (2d)
# enter the data

data1 <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/kmer_matrix/kmer_newport.csv')

#  Non-supervised kmeans clustering analysis

cluster_data <- data1 %>% select(tSNE1, tSNE2)

# determine the number of clusters with the elbow method

set.seed(123)

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(cluster_data, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

# or can use this function
set.seed(123)

p1 <- fviz_nbclust(cluster_data, kmeans, method = "wss")
p1 

# silhouette method
set.seed(123)
a1 <- fviz_nbclust(cluster_data, kmeans, method = "silhouette")
a1 

# combining both approaches we determine that 2 clusters are enough 
set.seed(123)
km.final <- kmeans(cluster_data, 4)
data1$cluster <- km.final$cluster
data1$cluster <- as.factor(data1$cluster)

# plot the kmer 2d cluster data

kmercluster <- ggplot(data1, aes(x = tSNE1, y = tSNE2, color = cluster)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("gray", "darkred", "steelblue", "purple")) +
   ggtitle("L.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Kmeans clusters') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
    guides(color = guide_legend(override.aes = list(size=20)))
kmercluster

######################################################################################

# snp data (2d)
# enter the data

data1 <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/newport/snp_matrix/snp_newport.csv')

#  Non-supervised kmeans clustering analysis

cluster_data <- data1 %>% select(tSNE1, tSNE2)

# determine the number of clusters with the elbow method

set.seed(123)

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(cluster_data, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

# or can use this function
set.seed(123)

p2 <- fviz_nbclust(cluster_data, kmeans, method = "wss")
p2 

# silhouette method
set.seed(123)
a2 <- fviz_nbclust(cluster_data, kmeans, method = "silhouette")
a2 

# combining both approaches we determine that 2 clusters are enough 
set.seed(123)
km.final <- kmeans(cluster_data, 3)
data1$cluster <- km.final$cluster
data1$cluster <- as.factor(data1$cluster)

# plot the kmer 2d cluster data

snpcluster <- ggplot(data1, aes(x = tSNE1, y = tSNE2, color = cluster)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("gray", "darkred", "steelblue")) +
   ggtitle("P.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Kmeans clusters') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
    guides(color = guide_legend(override.aes = list(size=20)))
snpcluster
```


Plots kmer and snp_distance-based distance tSNE analysis Typhimurium group 1

```{r, include = FALSE}

# Enter kmer-matrix

data1 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/group_1/kmer_matrix/kmer_group_1_typhimurium.csv")

#####################################################
# Enter MLST results

mlst <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/global_input_data/salmonellast_output.csv')

# QC the data

skim(mlst)

# Generate the id column 

mlst$id2 <- sapply(strsplit(as.character(mlst$FILE),'/'), "[", 3)
s1 <- mlst %>% separate(id2, c("id", "day"), sep = "\\.")

# Select columns of interest

s2 <- s1 %>%
          select(id, ST) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?")

# QC the data

skim(s2)

# st

s2$st <- ifelse(s2$ST == 19, "ST19", 
                   ifelse(s2$ST == 34, "ST34", 
                          ifelse(s2$ST == 36, "ST36",
                                 ifelse(s2$ST == 313, "ST313", "Other STs"))))

# Create data1 

data2 <- s2 

####################################################################

# Enter SISTR results

sistr <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/global_input_data/sistr_all.csv')

# QC the data 

skim(sistr)

# Select columns 

sis1 <- sistr %>%
            select(genome, cgmlst_ST, serovar_cgmlst) %>%
            mutate_all(na_if, "-") %>%
              mutate_all(na_if, "?") %>%
                rename(id = genome)

# Create serovar column

#data1 <- data1 %>% mutate(serovar_cgmlst = replace_na(serovar_cgmlst, 0))
sis1$serovar <- ifelse(sis1$serovar_cgmlst == "Typhimurium", "Biphasic",
                     ifelse(sis1$serovar_cgmlst == "I 4,[5],12:i:-", "Monophasic",
                            "Other serovars"))

# Create data2 and drop rows with missing values

data3 <- sis1 


##########################################################################

# Enter group1-Baps

# Enter the data, create a new column for group, and generate the id column
data4 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/group_1/input_data/roary_output_gr1.fastbaps_l6.csv")
data4$group <- "group_1"
colnames(data4)[1:2] <- c("id", "baps_1")

###########################################################################

# Merge data1 and data2

data5 <- left_join(data1, data2, on = "id")

# Merge data 1, 2, and 3 

data6 <- left_join(data5, data3, on = "id")

# Merge data 1, 2, 3, and 4

data7 <- left_join(data6, data4, on = "id")

# select columns

data8 <- data7 %>%
            select(id, tSNE1, tSNE2, st, cgmlst_ST, serovar, baps_1)

data8 <- mutate(data8, cgmlst = ifelse(cgmlst_ST %in% 1652656062, "cgMLST 1652656062",
                                     ifelse(cgmlst_ST %in% 860079270, "cgMLST 860079270", "Other cgMLSTs")))
########################################################

# Plot serovar 

serovar_data <- data8 %>%
              drop_na(serovar) %>%
              select(tSNE1, tSNE2, serovar) 


sero_plot <- ggplot(serovar_data, aes(x = tSNE1, y = tSNE2, color = serovar)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("gray", "darkblue", "red")) +
   ggtitle("A. Serovar (kmer-distance)") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Serovar') + 
  geom_jitter(pch = 21, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))
sero_plot

# Plot baps_1

baps_data <- data8 %>%
              drop_na(baps_1) %>%
              select(tSNE1, tSNE2, baps_1) 
baps_data$baps_1 <- factor(baps_data$baps_1, levels=c("1", "2", "3", "4", "5", "6"))


baps_plot <- ggplot(baps_data, aes(x = tSNE1, y = tSNE2, color = baps_1)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("orange", "darkgreen", "darkred", "gray", "darkblue", "darkcyan")) +
   ggtitle("Q.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='BAPS1') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
      guides(color = guide_legend(override.aes = list(size=20)))
baps_plot


# Plot ST

st_data <- data8 %>%
              #drop_na(st) %>%
  mutate(st = replace_na(st, "Other STs")) %>%
              select(tSNE1, tSNE2, st) 
st_data$st <- factor(st_data$st, levels=c("ST19", "ST34", "ST36", "ST313", "Other STs"))


st_plot <- ggplot(st_data, aes(x = tSNE1, y = tSNE2, color = st)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "darkgreen", "darkred", "gray", "orange")) +
   ggtitle("R.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='ST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
      guides(color = guide_legend(override.aes = list(size=20)))
st_plot


# Plot cgmlst 

cgmlst_data <- data8 %>%
              drop_na(cgmlst) %>%
              select(tSNE1, tSNE2, cgmlst) 
cgmlst_data$cgmlst <- factor(cgmlst_data$cgmlst, levels=c("cgMLST 1652656062", "cgMLST 860079270", "Other cgMLSTs"))


cgmlst_plot <- ggplot(cgmlst_data, aes(x = tSNE1, y = tSNE2, color = cgmlst)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "darkred", "gray")) +
   ggtitle("S.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='cgMLST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
      guides(color = guide_legend(override.aes = list(size=20)))
cgmlst_plot

##################################################################################

# Enter snp-matrix

data9 <- read_csv("~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/group_1/snp_matrix/snp_group_1_typhimurium.csv")


data10 <- data8[, -c(2:3)]

# Merge data 9 and 10

data11 <- left_join(data9, data10, on = "id")

# Plot serovar 

serovar_data2 <- data11 %>%
              drop_na(serovar) %>%
              select(tSNE1, tSNE2, serovar) 


sero_plot2 <- ggplot(serovar_data2, aes(x = tSNE1, y = tSNE2, color = serovar)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("gray", "darkblue", "red")) +
   ggtitle("E. Serovar (SNP-distance)") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Serovar') + 
  geom_jitter(pch = 21, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40))
sero_plot2

# Plot baps_1

baps_data2 <- data11 %>%
              drop_na(baps_1) %>%
              select(tSNE1, tSNE2, baps_1) 
baps_data2$baps_1 <- factor(baps_data2$baps_1, levels=c("1", "2", "3", "4", "5", "6"))


baps_plot2 <- ggplot(baps_data2, aes(x = tSNE1, y = tSNE2, color = baps_1)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("orange", "darkgreen", "darkred", "gray", "darkblue", "darkcyan")) +
   ggtitle("U.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='BAPS1') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
      guides(color = guide_legend(override.aes = list(size=20)))
baps_plot2


# Plot ST

st_data2 <- data11 %>%
              #drop_na(st) %>%
  mutate(st = replace_na(st, "Other STs")) %>%
              select(tSNE1, tSNE2, st) 
st_data2$st <- factor(st_data2$st, levels=c("ST19", "ST34", "ST36", "ST313", "Other STs"))


st_plot2 <- ggplot(st_data2, aes(x = tSNE1, y = tSNE2, color = st)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "darkgreen", "darkred", "gray", "orange")) +
   ggtitle("V.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='ST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
st_plot2


# Plot cgmlst 

cgmlst_data2 <- data11 %>%
              drop_na(cgmlst) %>%
              select(tSNE1, tSNE2, cgmlst) 
cgmlst_data2$cgmlst <- factor(cgmlst_data2$cgmlst, levels=c("cgMLST 1652656062", "cgMLST 860079270", "Other cgMLSTs"))


cgmlst_plot2 <- ggplot(cgmlst_data2, aes(x = tSNE1, y = tSNE2, color = cgmlst)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("darkblue", "darkred", "gray")) +
   ggtitle("W.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='cgMLST') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
cgmlst_plot2
```

Cluster analysis using core genome information Typhimurium

```{r, include = FALSE}

# kmer data (2d)
# enter the data

data1 <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/group_1/kmer_matrix/kmer_group_1_typhimurium.csv')

#  Non-supervised kmeans clustering analysis

cluster_data <- data1 %>% select(tSNE1, tSNE2)

# determine the number of clusters with the elbow method

set.seed(123)

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(cluster_data, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

# or can use this function
set.seed(123)

p1 <- fviz_nbclust(cluster_data, kmeans, method = "wss")
p1 

# silhouette method
set.seed(123)
a1 <- fviz_nbclust(cluster_data, kmeans, method = "silhouette")
a1 

# combining both approaches we determine that 2 clusters are enough 
set.seed(123)
km.final <- kmeans(cluster_data, 6)
data1$cluster <- km.final$cluster
data1$cluster <- as.factor(data1$cluster)

# plot the kmer 2d cluster data

kmercluster <- ggplot(data1, aes(x = tSNE1, y = tSNE2, color = cluster)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("black", "darkred", "steelblue", "purple", "orange", "darkgreen")) +
   ggtitle("T.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Kmeans clusters') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
  guides(color = guide_legend(override.aes = list(size=20)))
kmercluster

######################################################################################

# snp data (2d)
# enter the data

data1 <- read_csv('~/Documents/frontiers_paper_salmonella_newport_typhimurium/data/typhimurium/group_1/snp_matrix/snp_group_1_typhimurium.csv')

#  Non-supervised kmeans clustering analysis

cluster_data <- data1 %>% select(tSNE1, tSNE2)

# determine the number of clusters with the elbow method

set.seed(123)

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(cluster_data, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

# or can use this function
set.seed(123)

p2 <- fviz_nbclust(cluster_data, kmeans, method = "wss")
p2 

# silhouette method
set.seed(123)
a2 <- fviz_nbclust(cluster_data, kmeans, method = "silhouette")
a2 

# combining both approaches we determine that 2 clusters are enough 
set.seed(123)
km.final <- kmeans(cluster_data, 6)
data1$cluster <- km.final$cluster
data1$cluster <- as.factor(data1$cluster)

# plot the kmer 2d cluster data

snpcluster <- ggplot(data1, aes(x = tSNE1, y = tSNE2, color = cluster)) + 
  theme_bw() + 
  xlab("tSNE1") +
  ylab("tSNE2") +
  theme(axis.text.y = element_text(size = 40)) +
  theme(axis.title.y = element_text(size = 45, face = "bold")) +
  theme(axis.title.x = element_text(size = 45, face = "bold")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 40)) +
  scale_color_manual(values=c("black", "darkred", "steelblue", "purple", "orange", "darkgreen")) +
   ggtitle("X.") +
  theme(plot.title = element_text(size = 50, face = "bold")) + 
  labs(color='Kmeans clusters') + 
  geom_jitter(pch = 19, height = 1, width = 1, size = 4) +
  theme(legend.title=element_text(size=50, face = "bold")) +
  theme(legend.text=element_text(size=40)) +
 guides(color = guide_legend(override.aes = list(size=20))) 
snpcluster
```
